(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[974],{1277:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>W});var r=s(5155),a=s(2115),o=s(1154),l=s(5040),n=s(4616),i=s(2525),d=s(7550),c=s(1497),u=s(9869),m=s(7434),x=s(5196),h=s(4416);let f="http://localhost:8000";async function g(e,t){try{let{supabase:r}=await Promise.all([s.e(111),s.e(953)]).then(s.bind(s,8953));console.log("✏️ Updating chat title:",e,"New title:",t);let{error:a}=await r.from("chats").update({title:t,updated_at:new Date().toISOString()}).eq("id",e);if(a)throw console.error("Error updating chat title:",a),Error("Failed to update chat title");console.log("✅ Chat title updated successfully")}catch(e){throw console.error("Error in updateChatTitle:",e),e}}async function p(e){try{let t=await fetch("".concat(f,"/api/generate-title"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:e})});if(!t.ok)throw Error("Failed to generate chat title");return(await t.json()).title}catch(t){return console.error("Failed to generate chat title:",t),e.substring(0,40).trim()+(e.length>40?"...":"")}}async function b(e,t){try{console.log("\uD83D\uDCDA Creating knowledge base:",{name:e,description:t});let s=await fetch("".concat(f,"/api/kb/create"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e,description:t||""})});if(!s.ok){let e=await s.json().catch(()=>({}));throw Error(e.detail||"Failed to create knowledge base")}let r=await s.json();return console.log("✅ Knowledge base created:",r),r}catch(e){throw console.error("Error creating knowledge base:",e),e}}async function w(){try{var e;let t=await fetch("".concat(f,"/api/kb/list"));if(!t.ok)throw Error("Failed to load knowledge bases");let s=await t.json();return console.log("\uD83D\uDCDA Loaded knowledge bases:",(null==(e=s.knowledge_bases)?void 0:e.length)||0),s.knowledge_bases||[]}catch(e){throw console.error("Error in loadKnowledgeBases:",e),e}}async function j(e,t,s){return new Promise((r,a)=>{let o=new FormData;o.append("file",t);let l=new XMLHttpRequest;s&&l.upload.addEventListener("progress",e=>{e.lengthComputable&&s(e.loaded/e.total*100)}),l.addEventListener("load",()=>{if(200===l.status)console.log("✅ File uploaded successfully:",t.name),r();else{let e=Error("Upload failed with status ".concat(l.status));console.error("❌ Upload failed:",e),a(e)}}),l.addEventListener("error",()=>{let e=Error("Upload failed due to network error");console.error("❌ Upload error:",e),a(e)}),console.log("\uD83D\uDCE4 Uploading file to KB:",{kbId:e,filename:t.name}),l.open("POST","".concat(f,"/api/kb/").concat(e,"/upload")),l.send(o)})}async function v(e){try{let{supabase:t}=await Promise.all([s.e(111),s.e(953)]).then(s.bind(s,8953)),{data:r,error:a}=await t.from("chats").select("*").eq("kb_id",e).order("updated_at",{ascending:!1});if(a)throw console.error("Error loading KB chats:",a),a;return console.log("\uD83D\uDCAC Loaded KB chats:",(null==r?void 0:r.length)||0),r||[]}catch(e){throw console.error("Error in loadKBChats:",e),e}}async function y(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"New Chat";try{let{supabase:r}=await Promise.all([s.e(111),s.e(953)]).then(s.bind(s,8953)),{data:a,error:o}=await r.from("chats").insert({kb_id:e,title:t,messages:[]}).select().single();if(o)throw console.error("Error creating KB chat:",o),o;return console.log("✅ KB chat created:",a),a}catch(e){throw console.error("Error in createKBChat:",e),e}}async function N(e){try{let{supabase:t}=await Promise.all([s.e(111),s.e(953)]).then(s.bind(s,8953)),{error:r}=await t.from("chats").delete().eq("id",e);if(r)throw console.error("Error deleting KB chat:",r),r;console.log("✅ KB chat deleted:",e)}catch(e){throw console.error("Error in deleteKBChat:",e),e}}async function k(e,t,s){try{console.log("\uD83D\uDD0D Querying KB:",{kbId:e,question:t,chatId:s});let r=await fetch("".concat(f,"/api/kb/").concat(e,"/query"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({question:t,chat_id:s})});if(!r.ok){let e=await r.json().catch(()=>({}));throw Error(e.detail||"Failed to query knowledge base")}let a=await r.json();return console.log("✅ KB query response:",a),a}catch(e){throw console.error("Error querying KB:",e),e}}async function C(e){try{var t;console.log("\uD83D\uDCC4 Loading documents for KB:",e);let s=await fetch("".concat(f,"/api/kb/").concat(e,"/documents"),{method:"GET"});if(!s.ok){let e=await s.json().catch(()=>({}));throw Error(e.detail||"Failed to load documents: ".concat(s.statusText))}let r=await s.json();return console.log("✅ Loaded KB documents:",(null==(t=r.documents)?void 0:t.length)||0),r.documents||[]}catch(e){throw console.error("Error in loadKBDocuments:",e),e}}async function S(e){try{let{supabase:t}=await Promise.all([s.e(111),s.e(953)]).then(s.bind(s,8953)),{error:r}=await t.from("knowledge_bases").delete().eq("id",e);if(r)throw console.error("Error deleting knowledge base:",r),r;console.log("\uD83D\uDDD1️ Knowledge base deleted:",e)}catch(e){throw console.error("Error in deleteKnowledgeBase:",e),e}}async function E(e,t){try{console.log("\uD83D\uDDD1️ Deleting document:",{kbId:e,documentId:t});let s=await fetch("".concat(f,"/api/kb/").concat(e,"/documents/").concat(t),{method:"DELETE"});if(!s.ok){let e=await s.json().catch(()=>({}));throw Error(e.detail||"Failed to delete document")}console.log("✅ Document deleted successfully")}catch(e){throw console.error("Error deleting document:",e),e}}async function A(e,t){try{let{supabase:r}=await Promise.all([s.e(111),s.e(953)]).then(s.bind(s,8953));console.log("\uD83D\uDCBE Saving KB chat messages:",e,t.length);let{error:a}=await r.from("chats").update({messages:t,updated_at:new Date().toISOString()}).eq("id",e);if(a)throw console.error("Error saving KB chat messages:",a),a;console.log("✅ KB chat messages saved successfully")}catch(e){throw console.error("Error in saveKBChatMessages:",e),e}}async function F(e){try{let{supabase:t}=await Promise.all([s.e(111),s.e(953)]).then(s.bind(s,8953));console.log("\uD83D\uDCE5 Loading KB chat messages:",e);let{data:r,error:a}=await t.from("chats").select("messages").eq("id",e).single();if(a)return console.error("Error loading KB chat messages:",a),[];let o=(null==r?void 0:r.messages)||[];return console.log("✅ KB chat messages loaded:",o.length),o}catch(e){return console.error("Error in loadKBChatMessages:",e),[]}}function D(e){let{onSelectChat:t,onUploadFiles:f}=e,[g,p]=(0,a.useState)([]),[j,k]=(0,a.useState)(null),[A,F]=(0,a.useState)([]),[D,B]=(0,a.useState)([]),[K,P]=(0,a.useState)(null),[L,T]=(0,a.useState)(!0),[_,U]=(0,a.useState)(!1),[z,q]=(0,a.useState)(!1),[M,O]=(0,a.useState)(null),[I,W]=(0,a.useState)(!1),[R,V]=(0,a.useState)(null),[G,J]=(0,a.useState)(!1),[X,Y]=(0,a.useState)(!1),[H,Q]=(0,a.useState)(null),[Z,$]=(0,a.useState)(!1),[ee,et]=(0,a.useState)(""),[es,er]=(0,a.useState)("");async function ea(){try{T(!0);let e=await w();p(e)}catch(e){console.error("Failed to load knowledge bases:",e)}finally{T(!1)}}async function eo(e){try{Y(!0),Q(null);let[t,s]=await Promise.all([v(e),C(e)]);F(t),B(s),console.log("✅ Loaded documents:",s.length)}catch(e){console.error("Failed to load KB data:",e),Q(e instanceof Error?e.message:"Unknown error")}finally{Y(!1)}}async function el(){if(ee.trim())try{U(!0),await b(ee,es),await ea(),et(""),er(""),$(!1)}catch(e){console.error("Failed to create knowledge base:",e),alert("Failed to create knowledge base. Please try again.")}finally{U(!1)}}async function en(){if(j)try{q(!0);let e=await y(j.id,"New Chat");await eo(j.id),P(e),t(j.id,e.id)}catch(e){console.error("Failed to create chat:",e)}finally{q(!1)}}async function ei(e,t){if(t.stopPropagation(),confirm("Are you sure you want to delete this knowledge base? This action cannot be undone."))try{await S(e),await ea(),(null==j?void 0:j.id)===e&&(k(null),F([]),B([]))}catch(e){console.error("Failed to delete knowledge base:",e),alert("Failed to delete knowledge base. Please try again.")}}async function ed(){if(j&&M)try{W(!0),await E(j.id,M.id),await eo(j.id),O(null)}catch(e){console.error("Failed to delete document:",e),alert("Failed to delete document. Please try again.")}finally{W(!1)}}async function ec(){if(j&&R)try{J(!0),await N(R.id),await eo(j.id),V(null),(null==K?void 0:K.id)===R.id&&P(null)}catch(e){console.error("Failed to delete chat:",e),alert("Failed to delete chat. Please try again.")}finally{J(!1)}}return(0,a.useEffect)(()=>{ea()},[]),(0,a.useEffect)(()=>{j&&eo(j.id)},[j]),(0,a.useEffect)(()=>{let e;if(j)return(async()=>{let{supabase:t}=await Promise.all([s.e(111),s.e(953)]).then(s.bind(s,8953));e=t.channel("kb-chats-updates").on("postgres_changes",{event:"*",schema:"public",table:"chats",filter:"kb_id=eq.".concat(j.id)},e=>{console.log("\uD83D\uDCE1 Chat event (real-time):",e.eventType,e),eo(j.id)}).subscribe(e=>{console.log("\uD83D\uDCE1 Subscription status:",e)})})(),()=>{e&&e.unsubscribe()}},[j]),L?(0,r.jsx)("div",{className:"h-full flex items-center justify-center bg-sidebar",children:(0,r.jsx)(o.A,{className:"w-6 h-6 animate-spin text-primary"})}):j?(0,r.jsxs)("div",{className:"h-full flex flex-col bg-sidebar",children:[(0,r.jsxs)("div",{className:"p-4 border-b border-border bg-sidebar",children:[(0,r.jsxs)("button",{onClick:function(){k(null),F([]),B([]),P(null)},className:"w-full flex items-center justify-center gap-2 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-hover mb-6 transition-colors text-sm font-medium",children:[(0,r.jsx)(d.A,{className:"w-4 h-4"}),(0,r.jsx)("span",{children:"Back to Knowledge Bases"})]}),(0,r.jsxs)("div",{className:"flex items-center gap-2 mb-4",children:[(0,r.jsx)(c.A,{className:"w-5 h-5 text-primary"}),(0,r.jsx)("h2",{className:"text-base font-semibold text-foreground truncate",children:"Chats"})]}),(0,r.jsxs)("div",{className:"flex gap-2",children:[(0,r.jsxs)("button",{onClick:en,disabled:z,className:"flex-1 flex items-center justify-center gap-2 px-3 py-2 bg-primary text-white rounded-lg hover:bg-primary-hover disabled:opacity-50 transition-colors text-sm font-medium",children:[(0,r.jsx)(n.A,{className:"w-4 h-4"}),z?"Creating...":"New Chat"]}),(0,r.jsxs)("button",{onClick:()=>f(j.id),className:"flex-1 flex items-center justify-center gap-2 px-3 py-2 bg-accent text-accent-foreground rounded-lg hover:bg-accent/80 transition-colors text-sm font-medium",children:[(0,r.jsx)(u.A,{className:"w-4 h-4"}),"Upload"]})]})]}),(0,r.jsxs)("div",{className:"pt-6 px-4 pb-4 border-b border-border bg-sidebar",children:[(0,r.jsxs)("h3",{className:"text-sm font-medium text-foreground mb-2 flex items-center gap-2",children:[(0,r.jsx)(m.A,{className:"w-4 h-4 text-primary"}),"Documents (",D.length,")"]}),X?(0,r.jsxs)("div",{className:"flex items-center gap-2 text-xs text-muted-foreground p-2",children:[(0,r.jsx)(o.A,{className:"w-3 h-3 animate-spin text-primary"}),"Loading documents..."]}):H?(0,r.jsx)("div",{className:"text-xs text-destructive p-2 bg-destructive/10 rounded",children:"Failed to load documents"}):0===D.length?(0,r.jsxs)("div",{className:"text-xs text-muted-foreground p-2 text-center bg-muted/30 rounded",children:["No documents yet",(0,r.jsx)("button",{onClick:()=>f(j.id),className:"block w-full mt-2 text-primary hover:text-primary-hover transition-colors font-medium",children:"Upload your first document"})]}):(0,r.jsx)("div",{className:"space-y-1 max-h-32 overflow-y-auto",children:D.map(e=>(0,r.jsxs)("div",{className:"flex items-center gap-2 text-xs text-foreground p-2 bg-white rounded hover:bg-muted/30 transition-colors group",children:[(0,r.jsx)(m.A,{className:"w-3 h-3 flex-shrink-0 text-muted-foreground"}),(0,r.jsx)("span",{className:"truncate flex-1",children:e.filename}),"completed"===e.processing_status&&(0,r.jsx)(x.A,{className:"w-3 h-3 text-green-600"}),"processing"===e.processing_status&&(0,r.jsx)(o.A,{className:"w-3 h-3 animate-spin text-primary"}),"failed"===e.processing_status&&(0,r.jsx)(h.A,{className:"w-3 h-3 text-destructive"}),(0,r.jsx)("button",{onClick:t=>{t.stopPropagation(),O(e)},className:"opacity-0 group-hover:opacity-100 p-1 hover:bg-destructive/10 rounded transition-all",title:"Delete document",children:(0,r.jsx)(i.A,{className:"w-3 h-3 text-destructive"})})]},e.id))})]}),(0,r.jsx)("div",{className:"flex-1 overflow-y-auto pt-6 px-3 pb-3 space-y-1.5",children:0===A.length?(0,r.jsxs)("div",{className:"text-center py-12 px-4",children:[(0,r.jsx)(c.A,{className:"w-10 h-10 mx-auto text-muted-foreground mb-3"}),(0,r.jsx)("p",{className:"text-foreground/70 text-sm mb-4",children:"No chats yet"}),(0,r.jsx)("button",{onClick:en,className:"px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-hover transition-colors text-sm font-medium",children:"Start Your First Chat"})]}):A.map(e=>(0,r.jsxs)("div",{onClick:()=>{P(e),j&&t(j.id,e.id)},className:"p-3 rounded-lg cursor-pointer transition-all group ".concat((null==K?void 0:K.id)===e.id?"bg-muted/70 border border-primary":"bg-white border border-transparent hover:bg-muted/30"),children:[(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)(c.A,{className:"w-4 h-4 text-muted-foreground"}),(0,r.jsx)("h3",{className:"font-medium text-foreground text-sm truncate flex-1",children:e.title}),(0,r.jsx)("button",{onClick:t=>{t.stopPropagation(),V(e)},className:"opacity-0 group-hover:opacity-100 p-1 hover:bg-destructive/10 rounded transition-all",title:"Delete chat",children:(0,r.jsx)(i.A,{className:"w-3 h-3 text-destructive"})})]}),(0,r.jsx)("p",{className:"text-xs text-muted-foreground mt-1",children:new Date(e.updated_at).toLocaleDateString()})]},e.id))}),M&&(0,r.jsx)("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 px-4",children:(0,r.jsxs)("div",{className:"bg-white border border-border rounded-xl shadow-xl max-w-md w-full p-6 space-y-4",children:[(0,r.jsxs)("div",{className:"flex items-start gap-3",children:[(0,r.jsx)("div",{className:"p-2 rounded-full bg-destructive/10",children:(0,r.jsx)(i.A,{className:"w-5 h-5 text-destructive"})}),(0,r.jsxs)("div",{className:"flex-1",children:[(0,r.jsx)("h3",{className:"text-lg font-semibold text-foreground",children:"Delete document?"}),(0,r.jsxs)("p",{className:"text-sm text-muted-foreground mt-1",children:['This action cannot be undone. The document "',M.filename,'" will be removed.']})]})]}),(0,r.jsxs)("div",{className:"flex gap-3 justify-end",children:[(0,r.jsx)("button",{onClick:function(){I||O(null)},className:"px-4 py-2 rounded-lg border border-border text-foreground hover:bg-muted/50 transition-colors font-medium",disabled:I,children:"Cancel"}),(0,r.jsx)("button",{onClick:ed,className:"px-4 py-2 rounded-lg bg-destructive text-white hover:bg-destructive/90 transition-colors disabled:opacity-60 disabled:cursor-not-allowed font-medium",disabled:I,children:I?"Deleting...":"Delete"})]})]})}),R&&(0,r.jsx)("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 px-4",children:(0,r.jsxs)("div",{className:"bg-white border border-border rounded-xl shadow-xl max-w-md w-full p-6 space-y-4",children:[(0,r.jsxs)("div",{className:"flex items-start gap-3",children:[(0,r.jsx)("div",{className:"p-2 rounded-full bg-destructive/10",children:(0,r.jsx)(i.A,{className:"w-5 h-5 text-destructive"})}),(0,r.jsxs)("div",{className:"flex-1",children:[(0,r.jsx)("h3",{className:"text-lg font-semibold text-foreground",children:"Delete chat?"}),(0,r.jsxs)("p",{className:"text-sm text-muted-foreground mt-1",children:['This action cannot be undone. The chat "',R.title,'" and all its messages will be removed.']})]})]}),(0,r.jsxs)("div",{className:"flex gap-3 justify-end",children:[(0,r.jsx)("button",{onClick:function(){G||V(null)},className:"px-4 py-2 rounded-lg border border-border text-foreground hover:bg-muted/50 transition-colors font-medium",disabled:G,children:"Cancel"}),(0,r.jsx)("button",{onClick:ec,className:"px-4 py-2 rounded-lg bg-destructive text-white hover:bg-destructive/90 transition-colors disabled:opacity-60 disabled:cursor-not-allowed font-medium",disabled:G,children:G?"Deleting...":"Delete"})]})]})})]}):(0,r.jsxs)("div",{className:"h-full flex flex-col bg-sidebar",children:[(0,r.jsx)("div",{className:"p-4 border-b border-border bg-sidebar",children:(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsxs)("h2",{className:"text-base font-semibold text-foreground flex items-center gap-2",children:[(0,r.jsx)(l.A,{className:"w-5 h-5 text-primary"}),(0,r.jsx)("span",{children:"Knowledge Bases"})]}),(0,r.jsx)("button",{onClick:()=>$(!0),className:"p-1.5 hover:bg-muted rounded-lg transition-colors",title:"Create Knowledge Base",children:(0,r.jsx)(n.A,{className:"w-5 h-5 text-foreground"})})]})}),(0,r.jsx)("div",{className:"flex-1 overflow-y-auto p-3 space-y-2",children:0===g.length?(0,r.jsxs)("div",{className:"text-center py-12 px-4",children:[(0,r.jsx)(l.A,{className:"w-10 h-10 mx-auto text-muted-foreground mb-3"}),(0,r.jsx)("p",{className:"text-foreground/70 text-sm mb-4",children:"No knowledge bases yet"}),(0,r.jsx)("button",{onClick:()=>$(!0),className:"px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-hover transition-colors text-sm font-medium",children:"Create Your First KB"})]}):g.map(e=>(0,r.jsx)("div",{onClick:()=>{k(e),P(null)},className:"p-3 bg-white rounded-lg border border-border hover:bg-muted/30 cursor-pointer transition-all group",children:(0,r.jsxs)("div",{className:"flex items-start justify-between gap-2",children:[(0,r.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,r.jsx)("h3",{className:"font-medium text-foreground text-sm truncate",children:e.name}),e.description&&(0,r.jsx)("p",{className:"text-xs text-muted-foreground mt-1 line-clamp-2",children:e.description}),(0,r.jsx)("div",{className:"mt-2 text-xs text-muted-foreground",children:new Date(e.created_at).toLocaleDateString()})]}),(0,r.jsx)("button",{onClick:t=>ei(e.id,t),className:"opacity-0 group-hover:opacity-100 p-1 hover:bg-destructive/10 rounded transition-all flex-shrink-0",title:"Delete KB",children:(0,r.jsx)(i.A,{className:"w-4 h-4 text-destructive"})})]})},e.id))}),Z&&(0,r.jsx)("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:(0,r.jsxs)("div",{className:"bg-white rounded-xl max-w-md w-full p-6 border border-border shadow-xl",children:[(0,r.jsx)("h3",{className:"text-xl font-display font-semibold text-foreground mb-6",children:"Create Knowledge Base"}),(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium text-foreground mb-2",children:"Name *"}),(0,r.jsx)("input",{type:"text",value:ee,onChange:e=>et(e.target.value),placeholder:"My Research Project",className:"w-full px-4 py-2.5 border border-border rounded-lg bg-white text-foreground placeholder-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary",autoFocus:!0})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium text-foreground mb-2",children:"Description (optional)"}),(0,r.jsx)("textarea",{value:es,onChange:e=>er(e.target.value),placeholder:"A collection of research papers and data...",rows:3,className:"w-full px-4 py-2.5 border border-border rounded-lg bg-white text-foreground placeholder-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary resize-none"})]})]}),(0,r.jsxs)("div",{className:"flex gap-3 mt-6",children:[(0,r.jsx)("button",{onClick:()=>$(!1),className:"flex-1 px-4 py-2.5 border border-border text-foreground rounded-lg hover:bg-muted/50 transition-colors font-medium",children:"Cancel"}),(0,r.jsx)("button",{onClick:el,disabled:!ee.trim()||_,className:"flex-1 px-4 py-2.5 bg-primary text-white rounded-lg hover:bg-primary-hover disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center gap-2 font-medium",children:_?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(o.A,{className:"w-4 h-4 animate-spin"}),"Creating..."]}):"Create KB"})]})]})})]})}var B=s(7863),K=s(6474),P=s(2486),L=s(2893),T=s(4708),_=s(6766);function U(e){let{kbId:t,chatId:s,kbName:n}=e,[i,d]=(0,a.useState)([]),[c,u]=(0,a.useState)(""),[x,h]=(0,a.useState)(!1),[b,w]=(0,a.useState)(new Set),j=(0,a.useRef)(null),v=(0,a.useRef)(null);async function y(){if(!c.trim()||x)return;let e=0===i.length,r={role:"user",content:c,timestamp:Date.now()};d(e=>[...e,r]),u(""),h(!0),e&&p(c).then(async e=>{try{await g(s,e),console.log("✅ Chat title auto-generated:",e)}catch(e){console.error("Failed to update chat title:",e)}}).catch(e=>console.error("Title generation failed:",e));try{let e=await k(t,c,s),a={role:"assistant",content:e.response,timestamp:Date.now(),visualization:e.visualization};e.sources&&e.sources.length>0&&(a.sources=e.sources);let o=[...i,r,a];d(o);try{await A(s,o)}catch(e){console.error("Failed to save messages:",e)}}catch(t){console.error("Failed to query KB:",t);let e=[...i,r,{role:"assistant",content:"❌ Error: ".concat(t instanceof Error?t.message:"Failed to process your question. Please try again."),timestamp:Date.now()}];d(e);try{await A(s,e)}catch(e){console.error("Failed to save messages:",e)}}finally{h(!1)}}return(0,a.useEffect)(()=>{var e;null==(e=j.current)||e.scrollIntoView({behavior:"smooth"})},[i]),(0,a.useEffect)(()=>{var e;null==(e=v.current)||e.focus()},[]),(0,a.useEffect)(()=>{async function e(){try{let e=await F(s);e&&e.length>0&&(d(e),console.log("✅ Loaded",e.length,"messages from chat"))}catch(e){console.error("Failed to load chat messages:",e)}}d([]),e()},[s]),(0,r.jsxs)("div",{className:"h-full flex flex-col bg-white",children:[(0,r.jsxs)("div",{className:"flex-1 overflow-y-auto",children:[0===i.length?(0,r.jsxs)("div",{className:"h-full flex flex-col items-center justify-center text-center px-8 py-12",children:[(0,r.jsx)(l.A,{className:"w-12 h-12 text-primary/60 mb-4"}),(0,r.jsx)("h3",{className:"text-xl font-display font-semibold text-foreground mb-2",children:"Start a Conversation"}),(0,r.jsx)("p",{className:"text-sm text-muted-foreground max-w-md mb-6 leading-relaxed",children:"Ask questions about your uploaded documents, run analytics on your data, or request predictions based on your knowledge base."}),(0,r.jsxs)("div",{className:"space-y-2 w-full max-w-md",children:[(0,r.jsx)("p",{className:"text-xs font-medium text-foreground mb-3 text-left",children:"Try asking:"}),(0,r.jsx)("button",{onClick:()=>u("What are the main topics in these documents?"),className:"w-full text-left px-4 py-3 bg-white border border-border rounded-lg text-sm text-foreground hover:bg-muted/50 transition-colors",children:'"What are the main topics in these documents?"'}),(0,r.jsx)("button",{onClick:()=>u("Summarize the key findings from page 5"),className:"w-full text-left px-4 py-3 bg-white border border-border rounded-lg text-sm text-foreground hover:bg-muted/50 transition-colors",children:'"Summarize the key findings from page 5"'}),(0,r.jsx)("button",{onClick:()=>u("What trends can you identify in the data?"),className:"w-full text-left px-4 py-3 bg-white border border-border rounded-lg text-sm text-foreground hover:bg-muted/50 transition-colors",children:'"What trends can you identify in the data?"'})]})]}):i.map((e,t)=>(0,r.jsx)("div",{className:"w-full ".concat("user"===e.role?"bg-white":"bg-muted/20"," border-b border-border/50"),children:(0,r.jsx)("div",{className:"max-w-3xl mx-auto px-6 py-6",children:(0,r.jsxs)("div",{className:"flex gap-4 ".concat("user"===e.role?"flex-row-reverse":"flex-row"),children:[(0,r.jsx)("div",{className:"flex-shrink-0",children:(0,r.jsx)("div",{className:"w-8 h-8 rounded-full flex items-center justify-center text-xs font-semibold ".concat("user"===e.role?"bg-primary text-white":"bg-accent text-accent-foreground"),children:"user"===e.role?"U":"AI"})}),(0,r.jsxs)("div",{className:"flex-1 min-w-0 ".concat("user"===e.role?"text-right":""),children:[(0,r.jsx)("div",{className:"prose prose-sm max-w-none markdown-content",children:(0,r.jsx)(L.oz,{remarkPlugins:[T.A],children:e.content})}),e.visualization&&(0,r.jsx)("div",{className:"mt-4 border border-border rounded-xl overflow-hidden shadow-sm bg-white",children:"matplotlib_figure"===e.visualization.type?(0,r.jsx)(_.default,{src:"".concat(f).concat(e.visualization.path),alt:"Visualization",width:600,height:400,className:"w-full h-auto"}):(0,r.jsx)("iframe",{src:"".concat(f).concat(e.visualization.path),className:"w-full h-96",title:"Interactive Visualization"})}),"assistant"===e.role&&e.sources&&(0,r.jsxs)("div",{className:"mt-4 pt-4 border-t border-border/50",children:[(0,r.jsxs)("button",{onClick:()=>{w(e=>{let s=new Set(e);return s.has(t)?s.delete(t):s.add(t),s})},className:"flex items-center gap-2 text-sm font-medium text-foreground hover:text-primary transition-colors",children:[(0,r.jsx)(m.A,{className:"w-4 h-4"}),(0,r.jsxs)("span",{children:[e.sources.length," ",1===e.sources.length?"Source":"Sources"]}),b.has(t)?(0,r.jsx)(B.A,{className:"w-4 h-4"}):(0,r.jsx)(K.A,{className:"w-4 h-4"})]}),b.has(t)&&(0,r.jsx)("div",{className:"mt-3 space-y-2",children:e.sources.map(e=>(0,r.jsxs)("div",{className:"p-3 bg-muted/30 border border-border rounded-lg",children:[(0,r.jsx)("div",{className:"flex items-start justify-between mb-2",children:(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsxs)("span",{className:"text-xs font-semibold text-white bg-primary px-2 py-1 rounded",children:["Source ",e.number]}),(0,r.jsxs)("span",{className:"text-xs text-muted-foreground",children:["Relevance: ",(100*e.similarity).toFixed(1),"%"]})]})}),(0,r.jsx)("p",{className:"text-sm text-foreground/80 leading-relaxed",children:e.content}),e.metadata&&(0,r.jsx)("div",{className:"mt-2 text-xs text-muted-foreground",children:e.metadata.page&&(0,r.jsxs)("span",{children:["Page ",e.metadata.page]})})]},e.number))})]}),(0,r.jsx)("div",{className:"mt-3 text-xs text-muted-foreground",children:new Date(e.timestamp||Date.now()).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]})]})})},t)),x&&(0,r.jsx)("div",{className:"w-full bg-muted/20 border-b border-border/50",children:(0,r.jsx)("div",{className:"max-w-3xl mx-auto px-6 py-6",children:(0,r.jsxs)("div",{className:"flex gap-4",children:[(0,r.jsx)("div",{className:"flex-shrink-0",children:(0,r.jsx)("div",{className:"w-8 h-8 rounded-full bg-accent text-accent-foreground flex items-center justify-center text-xs font-semibold",children:"AI"})}),(0,r.jsxs)("div",{className:"flex items-center gap-2 pt-1",children:[(0,r.jsx)(o.A,{className:"w-4 h-4 animate-spin text-primary"}),(0,r.jsx)("span",{className:"text-sm text-muted-foreground",children:"Searching knowledge base..."})]})]})})}),(0,r.jsx)("div",{ref:j})]}),(0,r.jsx)("div",{className:"border-t border-border bg-white px-4 py-4",children:(0,r.jsxs)("div",{className:"max-w-3xl mx-auto",children:[(0,r.jsxs)("div",{className:"flex gap-3 items-end",children:[(0,r.jsx)("textarea",{ref:v,value:c,onChange:e=>u(e.target.value),onKeyDown:function(e){"Enter"!==e.key||e.shiftKey||(e.preventDefault(),y())},placeholder:"Ask a question about your knowledge base...",className:"flex-1 px-4 py-3 border border-border rounded-xl bg-white text-foreground placeholder-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary resize-none shadow-sm",rows:1,disabled:x}),(0,r.jsx)("button",{onClick:y,disabled:!c.trim()||x,className:"px-4 py-3 bg-primary text-white rounded-xl hover:bg-primary-hover disabled:opacity-40 disabled:cursor-not-allowed transition-all flex items-center justify-center shadow-sm",children:x?(0,r.jsx)(o.A,{className:"w-5 h-5 animate-spin"}):(0,r.jsx)(P.A,{className:"w-5 h-5"})})]}),(0,r.jsx)("p",{className:"text-xs text-muted-foreground mt-2 text-center",children:"Press Enter to send, Shift+Enter for new line"})]})})]})}var z=s(646),q=s(5339);let M=[".pdf",".docx",".txt",".csv",".xlsx",".xls"],O={pdf:"PDF Document",docx:"Word Document",txt:"Text File",csv:"CSV Data",xlsx:"Excel Spreadsheet",xls:"Excel Spreadsheet"};function I(e){let{kbId:t,onUploadComplete:s,onClose:l}=e,[n,i]=(0,a.useState)([]),[d,c]=(0,a.useState)(new Map),[x,f]=(0,a.useState)(!1),[g,p]=(0,a.useState)(!1),b=(0,a.useRef)(null);function w(e){e.target.files&&v(Array.from(e.target.files))}function v(e){let t=e.filter(e=>{var t;let s="."+(null==(t=e.name.split(".").pop())?void 0:t.toLowerCase());return M.includes(s)});t.length<e.length&&alert("Some files were rejected. Accepted types: ".concat(M.join(", "))),i(e=>{let s=new Set(e.map(e=>e.name));return[...e,...t.filter(e=>!s.has(e.name))]})}async function y(){if(0===n.length)return;f(!0);let e=new Map;for(let s of(n.forEach(t=>{e.set(t.name,{filename:t.name,progress:0,status:"uploading"})}),c(e),n))try{await j(t,s,e=>{c(t=>{let r=new Map(t);return r.set(s.name,{filename:s.name,progress:e,status:"uploading"}),r})}),c(e=>{let t=new Map(e);return t.set(s.name,{filename:s.name,progress:100,status:"processing"}),t}),setTimeout(()=>{c(e=>{let t=new Map(e);return t.set(s.name,{filename:s.name,progress:100,status:"completed"}),t})},1e3)}catch(e){console.error("Failed to upload ".concat(s.name,":"),e),c(t=>{let r=new Map(t);return r.set(s.name,{filename:s.name,progress:0,status:"failed",error:e instanceof Error?e.message:"Upload failed"}),r})}f(!1),Array.from(d.values()).every(e=>"completed"===e.status||"processing"===e.status)&&setTimeout(()=>{s(),l()},1500)}let N=n.length>0,k=Array.from(d.values()).filter(e=>"completed"===e.status||"processing"===e.status).length;return(0,r.jsx)("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:(0,r.jsxs)("div",{className:"bg-white rounded-xl max-w-2xl w-full max-h-[85vh] flex flex-col border border-border shadow-2xl",children:[(0,r.jsxs)("div",{className:"px-6 py-5 border-b border-border flex items-center justify-between",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("h2",{className:"text-xl font-display font-semibold text-foreground",children:"Upload Files to Knowledge Base"}),(0,r.jsx)("p",{className:"text-sm text-muted-foreground mt-1",children:"Supported: PDF, DOCX, TXT, CSV, Excel"})]}),(0,r.jsx)("button",{onClick:l,className:"p-2 hover:bg-muted rounded-lg transition-colors",children:(0,r.jsx)(h.A,{className:"w-5 h-5 text-muted-foreground"})})]}),(0,r.jsx)("div",{className:"flex-1 overflow-y-auto p-6 bg-muted/20",children:N?(0,r.jsxs)("div",{className:"space-y-3",children:[n.map((e,t)=>{var s,a,l;let n=d.get(e.name),c=(null==n?void 0:n.status)==="completed"||(null==n?void 0:n.status)==="processing",u=(null==n?void 0:n.status)==="failed";return(0,r.jsx)("div",{className:"border border-border rounded-lg p-4 bg-white shadow-sm",children:(0,r.jsxs)("div",{className:"flex items-start gap-3",children:[(0,r.jsx)("div",{className:"flex-shrink-0",children:(null==(s=e.name.split(".").pop())||s.toLowerCase(),(0,r.jsx)(m.A,{className:"w-5 h-5 text-blue-600"}))}),(0,r.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between mb-1",children:[(0,r.jsx)("h4",{className:"text-sm font-medium text-foreground truncate",children:e.name}),!x&&!n&&(0,r.jsx)("button",{onClick:()=>{i(e=>e.filter((e,s)=>s!==t))},className:"p-1 hover:bg-muted rounded transition-colors",children:(0,r.jsx)(h.A,{className:"w-4 h-4 text-muted-foreground"})}),c&&(0,r.jsx)(z.A,{className:"w-5 h-5 text-green-600 flex-shrink-0"}),u&&(0,r.jsx)(q.A,{className:"w-5 h-5 text-destructive flex-shrink-0"}),(null==n?void 0:n.status)==="uploading"&&(0,r.jsx)(o.A,{className:"w-5 h-5 text-primary animate-spin flex-shrink-0"}),(null==n?void 0:n.status)==="processing"&&(0,r.jsx)(o.A,{className:"w-5 h-5 text-primary animate-spin flex-shrink-0"})]}),(0,r.jsxs)("div",{className:"flex items-center gap-3 text-xs text-muted-foreground",children:[(0,r.jsx)("span",{children:O[(null==(a=e.name.split(".").pop())?void 0:a.toLowerCase())||""]||"File"}),(0,r.jsx)("span",{children:"•"}),(0,r.jsx)("span",{children:(l=e.size)<1024?l+" B":l<1048576?(l/1024).toFixed(1)+" KB":(l/1048576).toFixed(1)+" MB"})]}),n&&(0,r.jsxs)("div",{className:"mt-3",children:[(0,r.jsx)("div",{className:"flex items-center justify-between text-xs mb-1.5",children:(0,r.jsxs)("span",{className:"text-muted-foreground font-medium",children:["uploading"===n.status&&"Uploading ".concat(Math.round(n.progress),"%"),"processing"===n.status&&"Processing...","completed"===n.status&&"Completed","failed"===n.status&&n.error]})}),(0,r.jsx)("div",{className:"w-full bg-muted rounded-full h-2 overflow-hidden",children:(0,r.jsx)("div",{className:"h-full rounded-full transition-all duration-300 ".concat("completed"===n.status?"bg-green-600":"processing"===n.status?"bg-primary":"failed"===n.status?"bg-destructive":"bg-primary"),style:{width:"".concat(n.progress,"%")}})})]})]})]})},t)}),!x&&(0,r.jsxs)("button",{onClick:()=>{var e;return null==(e=b.current)?void 0:e.click()},className:"w-full p-4 border-2 border-dashed border-border rounded-lg hover:border-primary/50 hover:bg-muted/30 transition-all bg-white flex items-center justify-center gap-2 text-muted-foreground font-medium",children:[(0,r.jsx)(u.A,{className:"w-4 h-4"}),"Add More Files"]}),(0,r.jsx)("input",{ref:b,type:"file",multiple:!0,accept:M.join(","),onChange:w,className:"hidden"})]}):(0,r.jsxs)("div",{onDrop:function(e){e.preventDefault(),p(!1),e.dataTransfer.files&&v(Array.from(e.dataTransfer.files))},onDragOver:function(e){e.preventDefault(),p(!0)},onDragLeave:function(e){e.preventDefault(),p(!1)},onClick:()=>{var e;return null==(e=b.current)?void 0:e.click()},className:"border-2 border-dashed rounded-xl p-12 text-center cursor-pointer transition-all bg-white ".concat(g?"border-primary bg-primary/5":"border-border hover:border-primary/50 hover:bg-muted/30"),children:[(0,r.jsx)(u.A,{className:"w-12 h-12 mx-auto text-muted-foreground mb-4"}),(0,r.jsx)("p",{className:"text-lg font-semibold text-foreground mb-2",children:"Drop files here or click to browse"}),(0,r.jsx)("p",{className:"text-sm text-muted-foreground",children:"Upload PDFs, Word documents, text files, or spreadsheets"}),(0,r.jsx)("input",{ref:b,type:"file",multiple:!0,accept:M.join(","),onChange:w,className:"hidden"})]})}),(0,r.jsxs)("div",{className:"px-6 py-5 border-t border-border bg-muted/20",children:[x&&(0,r.jsxs)("div",{className:"mb-4 text-center text-sm text-muted-foreground",children:["Uploading ",k," of ",n.length," files..."]}),(0,r.jsxs)("div",{className:"flex gap-3",children:[(0,r.jsx)("button",{onClick:l,disabled:x,className:"flex-1 px-4 py-2.5 border border-border text-foreground rounded-lg hover:bg-muted/50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors font-medium",children:x?"Uploading...":"Cancel"}),(0,r.jsx)("button",{onClick:y,disabled:!N||x,className:"flex-1 px-4 py-2.5 bg-primary text-white rounded-lg hover:bg-primary-hover disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center gap-2 font-medium",children:x?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(o.A,{className:"w-4 h-4 animate-spin"}),"Uploading..."]}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(u.A,{className:"w-4 h-4"}),"Upload ",n.length," ",1===n.length?"File":"Files"]})})]})]})]})})}function W(){let[e,t]=(0,a.useState)(null),[s,o]=(0,a.useState)(null),[l,n]=(0,a.useState)(!1),[i,d]=(0,a.useState)(null);return(0,r.jsx)("div",{className:"min-h-screen bg-white text-foreground",children:(0,r.jsxs)("div",{className:"h-screen flex flex-col",children:[(0,r.jsx)("header",{className:"h-14 border-b border-border bg-white flex items-center justify-between px-4 shadow-sm",children:(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)(_.default,{src:"/Geo-Logo1.png",alt:"DramaGPT Logo",width:32,height:32,className:"h-8 w-auto object-contain"}),(0,r.jsx)("h1",{className:"text-lg font-semibold text-foreground",children:"DramaGPT"})]})}),(0,r.jsxs)("div",{className:"flex-1 flex overflow-hidden bg-white",children:[(0,r.jsx)("div",{className:"w-80 border-r border-border bg-sidebar overflow-y-auto",children:(0,r.jsx)(D,{onSelectChat:function(e,s){console.log("Selected chat:",{kbId:e,chatId:s}),t({id:e,name:"Loading..."}),o(s)},onUploadFiles:function(e){d(e),n(!0)}})}),(0,r.jsx)("div",{className:"flex-1 flex flex-col bg-white",children:e&&s?(0,r.jsx)(U,{kbId:e.id,chatId:s,kbName:e.name}):(0,r.jsxs)("div",{className:"flex-1 flex flex-col bg-white",children:[(0,r.jsx)("div",{className:"flex-1"}),(0,r.jsx)("div",{className:"border-t border-border bg-white p-4",children:(0,r.jsxs)("div",{className:"max-w-4xl mx-auto",children:[(0,r.jsxs)("div",{className:"relative",children:[(0,r.jsx)("input",{type:"text",disabled:!0,placeholder:"Select a knowledge base and chat to get started...",className:"w-full px-4 py-3 pr-12 border border-border rounded-lg bg-muted/30 text-muted-foreground placeholder-muted-foreground cursor-not-allowed focus:outline-none"}),(0,r.jsx)("button",{disabled:!0,className:"absolute right-2 top-1/2 -translate-y-1/2 p-2 rounded-lg bg-muted text-muted-foreground cursor-not-allowed",children:(0,r.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"w-5 h-5",children:[(0,r.jsx)("path",{d:"M22 2L11 13"}),(0,r.jsx)("path",{d:"M22 2L15 22L11 13L2 9L22 2Z"})]})})]}),(0,r.jsx)("p",{className:"text-xs text-muted-foreground mt-2 text-center",children:"Create or select a knowledge base from the sidebar to start chatting"})]})})]})})]}),l&&i&&(0,r.jsx)(I,{kbId:i,onUploadComplete:function(){console.log("Upload complete, refreshing...")},onClose:function(){n(!1),d(null)}})]})})}},4797:(e,t,s)=>{Promise.resolve().then(s.bind(s,1277))}},e=>{var t=t=>e(e.s=t);e.O(0,[786,441,684,358],()=>t(4797)),_N_E=e.O()}]);